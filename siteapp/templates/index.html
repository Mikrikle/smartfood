{% load static %}


<script>

    let createRowDiv = function(text)
    {
        let div_foodList = document.createElement('div');
        div_foodList.className = "FoodList";

        let div_name = document.createElement('div');
        div_name.innerHTML = `${text}`;
        div_name.className = "foodListItemName"
        let input_weight = document.createElement('input');
        input_weight.value = 100;
        input_weight.setAttribute("maxlength", "4");
        input_weight.setAttribute("required", "true");
        input_weight.setAttribute("type", "number");
        input_weight.className = "foodListItemInputWeight";
        input_weight.innerHTML = `${100}`;
        input_weight.addEventListener(
            'keyup', function(){
                this.value = this.value.replace(/[^\d]/g, '');
            }
        );
        div_foodList.append(div_name);
        div_foodList.append(input_weight);
        return div_foodList;
    } 


    document.addEventListener("DOMContentLoaded",
        function(){
            document.getElementById("handleForm").addEventListener("click", 
                function()
                {
                    let formData  = new FormData( document.getElementById("form") );

                    for(let i = 0; i < document.getElementById("img").files.length; i++)
                    {
                        formData.append("img[]",document.getElementById("img").files[i]);
                    }

                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", "{% url 'customvision' %}");

                    xhr.addEventListener("readystatechange", () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            let response = JSON.parse(xhr.response);
                            let rl = document.getElementById("rezult_list");
                            console.log(response.rezult);
                            if(response.rezult)
                            {
                                for (let i = 0; i < response.rezult.length; ++i)
                                {
                                    rl.append(createRowDiv(response.rezult[i]));
                                }
                            }
                        };
                    });
                    xhr.send(formData);
                }
            );
        }
    );

    document.addEventListener("DOMContentLoaded", 
        function(){
            let elements = document.querySelectorAll(".fooditem");
            let rl = document.getElementById("rezult_list");
            for (var i = 0; i < elements.length; i++) {
                elements[i].onclick = function(){
                    rl.append(createRowDiv(this.querySelector(".fooditem_name").innerHTML));
                };
            }
        }
    );
    

    document.addEventListener("DOMContentLoaded", 
        function(){
            document.getElementById("btn_confirm").addEventListener("click", 
                function() {
                        let rl = document.getElementById("rezult_list");
                        let rez = [];
                        for( let i=0; i < rl.childNodes.length; ++i)
                        {
                            if(rl.childNodes[i].innerHTML)
                                rez.push(JSON.stringify({"name": rl.childNodes[i].querySelector(".foodListItemName").innerHTML,
                                "weight":rl.childNodes[i].querySelector(".foodListItemInputWeight").value}));
                        }
                        console.log(rez);

                        const request = new XMLHttpRequest();
                        const url = "{% url 'add' %}";
                        const params = `csrfmiddlewaretoken={{ csrf_token }}&data=${rez.join(";")}`;
                        request.open("POST", url, true);
                        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                        request.send(params);
                }
            );
        }
    );
</script>

<body>

    <a href="{% url 'info' %}">кнопка</a>

    <h5>Выбрать из списка или фото</h5>
    {% for item in foodlist %}
    <div class="fooditem">
        <div class="fooditem_name">{{ item.name }}</div>
        <img src="{{item.img.url}}" alt={item.name}} width="64" height="64"></a>
    </div>
    {% endfor %}

    <form action="" method="post" enctype="multipart/form-data" id="form" class="dropzone" id="dropzone">
        {% csrf_token %}
        <input type="file" name="img" id="img" multiple />
        <div id="handleForm">Send</div>
    </form>


    <h5>Результат</h5>
    <div id="rezult_list">
    </div>

    <div id="btn_confirm">ПОДТВЕРДИТЬ</div>
</body>
