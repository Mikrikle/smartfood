{% load static %}

<link
    rel="stylesheet"
    type="text/css"
    href="{% static '/css/bootstrap.css' %}"
/>

<script>

    let current_all_food_list = []
    //let current_selected_food_list = []

    // создание div с названием еды и весом
    let createRowDiv = function(text)
    {  
        let rl = document.getElementById("rezult_list");
        let div_foodList = document.createElement('div');
        div_foodList.className = "FoodList";

        let div_name = document.createElement('div');
        div_name.innerHTML = `${text}`;
        div_name.className = "foodListItemName"
        let input_weight = document.createElement('input');
        input_weight.value = 100;
        input_weight.setAttribute("maxlength", "4");
        input_weight.setAttribute("required", "true");
        input_weight.setAttribute("type", "number");
        input_weight.className = "foodListItemInputWeight";
        input_weight.innerHTML = `${100}`;
        input_weight.addEventListener(
            'keyup', function(){
                this.value = this.value.replace(/[^\d]/g, '');
            }
        );
        div_foodList.append(div_name);
        div_foodList.append(input_weight);
        rl.append(div_foodList);
    } 

    // добавляет еду в список текущей еды
    let addToFoodList = function(name, visionname)
    {
        createRowDiv(name)
        current_all_food_list.push(visionname);
        console.log(current_all_food_list);
    }

    // распознавание еды по фото
    document.addEventListener("DOMContentLoaded",
        function(){
            document.getElementById("handleForm").addEventListener("click", 
                function()
                {
                    // отправка данных на сервер
                    let formData  = new FormData( document.getElementById("form") );

                    for(let i = 0; i < document.getElementById("img").files.length; i++)
                    {
                        formData.append("img[]",document.getElementById("img").files[i]);
                    }

                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", "{% url 'customvision' %}");
                    
                    // получение ответа от сервера
                    xhr.addEventListener("readystatechange", () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            let response = JSON.parse(xhr.response);
                            console.log(response.rezult);
                            if(response.rezult)
                            {
                                for (let i = 0; i < response.rezult.length; ++i)
                                {
                                    addToFoodList(response.names[i], response.rezult[i])
                                }
                            }
                        };
                    });
                    xhr.send(formData);
                }
            );
        }
    );

    // Добавляет еду из списка по клику на нее
    document.addEventListener("DOMContentLoaded", 
        function(){
            let elements = document.querySelectorAll(".fooditem");
            let rl = document.getElementById("rezult_list");
            for (var i = 0; i < elements.length; i++) {
                elements[i].onclick = function(){
                    addToFoodList(this.querySelector(".fooditem_name").innerHTML, 
                    this.querySelector(".fooditem_model_name").innerHTML);
                };
            }
        }
    );
    
    // Отправка данных для получения списка возможных блюд
    document.addEventListener("DOMContentLoaded", 
        function(){
            document.getElementById("btn_confirm").addEventListener("click", 
                function() {
                    const xhr = new XMLHttpRequest();
                    const url = "{% url 'foodanalize' %}";
                    const params = `csrfmiddlewaretoken={{ csrf_token }}&data=${current_all_food_list}`;
                    xhr.open("POST", url, true);
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                    // получение ответа от сервера
                    xhr.addEventListener("readystatechange", () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            let response = JSON.parse(xhr.response);
                            console.log(response);
                        };
                    });                   

                    xhr.send(params);
                }
            );
        }
    );
</script>

<body>

    <div class="container">
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
      <a href="{% url 'index' %}" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
        <img src="{% static 'images/logo.jpg' %}" width="40" height="32"/>
        <span class="fs-4">SmartFood</span>
      </a>

      <ul class="nav nav-pills">
        <li class="nav-item"><a href="{% url 'index' %}" class="nav-link active" aria-current="page">Главная</a></li>
        <li class="nav-item"><a href="{% url 'faq' %}" class="nav-link">FAQs</a></li>
      </ul>
    </header>
  </div>

    <h5>Выбрать из списка или фото</h5>
    {% for item in foodlist %}
    <div class="fooditem" onClick = >
        <div class="fooditem_name">{{ item.name }}</div>
        <div class="fooditem_model_name">{{ item.visionname }}</div>
        <img src="{{item.img.url}}" alt={{item.name}} width="64" height="64"></a>
    </div>
    {% endfor %}

    <form action="" method="post" enctype="multipart/form-data" id="form" class="dropzone" id="dropzone">
        {% csrf_token %}
        <input type="file" name="img" id="img" multiple />
        <div id="handleForm">Send</div>
    </form>


    <h5>Результат</h5>
    <div id="rezult_list">
    </div>

    <div id="btn_confirm">ПОДТВЕРДИТЬ</div>
</body>
